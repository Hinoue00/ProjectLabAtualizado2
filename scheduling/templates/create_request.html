{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load scheduling_filters %}

{% block title %}Solicitar Agendamento | LabConnect{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/create-request-optimized.css' %}">
<style>
.materials-grid {
    max-height: 400px;
    overflow-y: auto;
}

.material-card {
    border: 1px solid #dee2e6;
    transition: all 0.2s;
}

.material-card:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.form-check-input:checked ~ .form-check-label {
    font-weight: bold;
    color: #007bff;
}

.material-card .form-check {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="page-title">
                    {% if is_edit %}
                        {{ title|default:"Editar Rascunho de Agendamento" }}
                    {% else %}
                        Solicitar Agendamento
                    {% endif %}
                </h1>
                <p class="page-subtitle">
                    {% if is_edit %}
                        Modifique os dados do seu rascunho de agendamento
                    {% else %}
                        Agende um laboratório para sua aula
                    {% endif %}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="{% url 'professor_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Draft Warning -->
    {% if not is_confirmation_day %}
    <div class="draft-warning d-flex align-items-center mb-4">
        <div class="draft-warning-icon">
            <i class="bi bi-info-circle"></i>
        </div>
        <div>
            <h5 class="mb-2">Aviso de Rascunho</h5>
            <p class="mb-0">
                Você está criando um rascunho de agendamento. Só será possível confirmar e enviar 
                este agendamento na próxima quinta ou sexta-feira. 
                <a href="{% url 'list_draft_schedule_requests' %}" class="alert-link">
                    Ver meus rascunhos
                </a>
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Scheduling Request Container -->
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="schedule-request-container">
                <!-- Informative Alert -->
                <div class="alert alert-info m-3" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    Você está 
                    {% if is_confirmation_day or request.user.is_staff %}
                        confirmando um agendamento
                    {% else %}
                        criando um rascunho
                    {% endif %}
                    para a semana de <strong>{{ next_week_start|date:"d/m/Y" }}</strong> a <strong>{{ next_week_end|date:"d/m/Y" }}</strong>
                </div>

                <!-- Request Form -->
                <form method="post" id="scheduleRequestForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Hidden lab selection field -->
                    {{ form.laboratory.as_hidden }}

                    <div class="request-body">
                        <!-- Laboratory Selection -->
                        <div class="form-section mb-5 laboratory-suggestion">
                            <h5><i class="bi bi-building me-2"></i>Selecione o Laboratório</h5>
                            
                            <div class="mb-4">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                                            <input type="text" id="labSearch" class="form-control" placeholder="Buscar laboratório...">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <select id="departmentFilter" class="form-select">
                                            <option value="all">Todos os departamentos</option>
                                            {% for dept in departments %}
                                                <option value="{{ dept.code }}">{{ dept.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lab-selection-container">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Laboratório</th>
                                                <th>Departamento</th>
                                                <th>Capacidade</th>
                                                <th>Ação</th>
                                            </tr>
                                        </thead>
                                        <tbody id="labsTableBody">
                                            {% for laboratory in form.laboratory.field.queryset %}
                                            <tr class="lab-row" data-laboratory-id="{{ laboratory.id }}" data-department="{{ laboratory|department_codes|join:',' }}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="lab-icon me-2">
                                                            <i class="bi bi-building text-primary"></i>
                                                        </div>
                                                        <span>{{ laboratory.name }}</span>
                                                    </div>
                                                </td>
                                                <td>{{ laboratory.get_departments_display }}</td>
                                                <td>{{ laboratory.capacity }} pessoas</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-primary select-lab-btn">
                                                        Selecionar
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-3">
                                                    <i class="bi bi-building"></i>
                                                    <p class="mb-0">Nenhum laboratório disponível</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div id="noLabsFound" class="text-center py-4 d-none">
                                    <i class="bi bi-search text-muted" style="font-size: 2rem;"></i>
                                    <h6 class="mt-3 mb-0">Nenhum laboratório encontrado</h6>
                                    <p class="text-muted">Tente outro termo de busca ou filtro</p>
                                </div>
                                
                                <div id="selectedLabInfo" class="mt-4 p-3 rounded d-none">
                                    <div class="d-flex align-items-start">
                                        <div class="selected-lab-icon me-3 p-3 rounded">
                                            <i class="bi bi-building-check fs-1"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">Laboratório selecionado:</h6>
                                            <h5 id="selectedLabName" class="mb-2">Nome do laboratório</h5>
                                            <p id="selectedLabDetails" class="mb-0 text-muted">Departamento | Capacidade: x pessoas</p>
                                        </div>
                                        <button type="button" id="changeLabBtn" class="btn btn-sm btn-outline-secondary ms-auto">
                                            <i class="bi bi-pencil"></i> Alterar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resto do formulário permanece inalterado -->
                        <!-- Basic Information -->
                        <div class="form-section mb-5">
                            <h5><i class="bi bi-info-circle me-2"></i>Informações Básicas</h5>
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.subject.id_for_label }}" class="form-label">Disciplina/Assunto</label>
                                    <input type="text" name="{{ form.subject.name }}" id="{{ form.subject.id_for_label }}" 
                                           class="form-control" placeholder="Ex: Física Experimental" required>
                                    <div class="form-text">Informe a disciplina ou o assunto da aula</div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <label for="id_scheduled_date" class="form-label">Data Agendada</label>
                                    <input type="date" name="scheduled_date" id="id_scheduled_date" class="form-control" 
                                           min="{{ next_week_start|date:'Y-m-d' }}" max="{{ next_week_end|date:'Y-m-d' }}" required>
                                    <div class="form-text">Selecione uma data da próxima semana</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="id_shift" class="form-label">Turno</label>
                                    <select name="shift" id="id_shift" class="form-select" required>
                                        <option value="" {% if not form.shift.value %}selected{% endif %}>Selecione o turno</option>
                                        <option value="morning" {% if form.shift.value == "morning" %}selected{% endif %}>
                                            <i class="bi bi-sunrise"></i> Matutino (08:00 - 12:00)
                                        </option>
                                        <option value="evening" {% if form.shift.value == "evening" %}selected{% endif %}>
                                            <i class="bi bi-moon-stars"></i> Noturno (19:00 - 22:00)
                                        </option>
                                    </select>
                                    <div class="form-text">Escolha o período do dia para sua aula</div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.number_of_students.id_for_label }}" class="form-label">Número de Alunos</label>
                                    <input type="number" name="{{ form.number_of_students.name }}" 
                                           id="{{ form.number_of_students.id_for_label }}" class="form-control" 
                                           placeholder="Ex: 30" min="1">
                                    <div class="form-text">Quantidade de alunos que participarão da aula</div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.class_semester.id_for_label }}" class="form-label">Semestre/Turma</label>
                                    <input type="text" name="{{ form.class_semester.name }}" 
                                           id="{{ form.class_semester.id_for_label }}" class="form-control" 
                                           placeholder="Ex: 1º Semestre">
                                    <div class="form-text">Identificação do semestre ou turma</div>
                                </div>
                            </div>
                        </div>

                        <!-- Description and Materials -->
                        <div class="form-section mb-5">
                            <h5><i class="bi bi-file-text me-2"></i>Detalhes da Atividade</h5>
                            <div class="mb-4">
                                <label for="{{ form.description.id_for_label }}" class="form-label">Descrição da Atividade <span class="text-muted">(opcional)</span></label>
                                <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" 
                                          class="form-control" rows="4" 
                                          placeholder="Descreva detalhadamente a atividade que será realizada (opcional)..."></textarea>
                            </div>
                            
                            <div class="mb-4">
                                <label for="{{ form.materials.id_for_label }}" class="form-label">Materiais Necessários (Descrição)</label>
                                <textarea name="{{ form.materials.name }}" id="{{ form.materials.id_for_label }}" 
                                          class="form-control" rows="3" 
                                          placeholder="Descreva os materiais necessários..."></textarea>
                            </div>
                            
                            <!-- Seleção de Materiais do Laboratório -->
                            <div class="mb-4" id="laboratoryMaterialsSection" style="display: none;">
                                <label class="form-label">Materiais Disponíveis no Laboratório</label>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Selecione os materiais que você pretende usar na aula.
                                </div>
                                
                                <!-- Busca de Materiais -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" id="materialSearch" class="form-control" placeholder="Buscar materiais...">
                                        <button type="button" class="btn btn-outline-secondary" id="searchAllLabsBtn">
                                            <i class="bi bi-building me-1"></i>Buscar em Todos os Labs
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="materialsList" class="materials-grid">
                                    <div class="text-center text-muted">
                                        <i class="bi bi-box-seam fs-1"></i>
                                        <p>Selecione um laboratório para ver os materiais disponíveis</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attachments Section -->
                        <div class="form-section">
                            <h5><i class="bi bi-paperclip me-2"></i>Anexos</h5>
                            
                            <!-- Mostrar arquivo existente se estiver editando -->
                            {% if is_edit and draft_request.guide_file %}
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-file-earmark me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>Arquivo atual:</strong> {{ draft_request.guide_file.name|basename }}
                                        <small class="d-block text-muted">Você pode substituir este arquivo anexando um novo abaixo</small>
                                    </div>
                                    <a href="{{ draft_request.guide_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye me-1"></i>Visualizar
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="custom-file-upload" id="dropArea">
                                <input type="file" name="attachments" id="id_attachments" multiple class="d-none">
                                <div class="custom-file-icon">
                                    <i class="bi bi-cloud-arrow-up"></i>
                                </div>
                                <h6>Arraste arquivos ou clique para anexar</h6>
                                <p>Você pode anexar roteiros de aula, imagens ou qualquer outro documento</p>
                                <div id="filePreview" class="file-preview"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Request Footer -->
                    <div class="request-footer">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <a href="{% url 'professor_dashboard' %}" class="btn btn-outline-secondary mb-2 mb-md-0">
                                <i class="bi bi-x-lg me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                {% if is_confirmation_day or request.user.is_staff %}
                                    <i class="bi bi-calendar-plus me-1"></i> Enviar Agendamento
                                {% else %}
                                    <i class="bi bi-save me-1"></i> Salvar Rascunho
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Laboratory Selection
        const labSelect = document.getElementById('id_laboratory');
        const labRows = document.querySelectorAll('.lab-row');
        const labSearch = document.getElementById('labSearch');
        const departmentFilter = document.getElementById('departmentFilter');
        const selectedLabInfo = document.getElementById('selectedLabInfo');
        const selectedLabName = document.getElementById('selectedLabName');
        const selectedLabDetails = document.getElementById('selectedLabDetails');
        const changeLabBtn = document.getElementById('changeLabBtn');
        const noLabsFound = document.getElementById('noLabsFound');
        const labsTableBody = document.getElementById('labsTableBody');
        
        // Show selected lab if one is already selected
        if (labSelect && labSelect.value) {
            const selectedRow = document.querySelector(`.lab-row[data-laboratory-id="${labSelect.value}"]`);
            if (selectedRow) {
                selectLab(selectedRow);
                loadLaboratoryMaterials(labSelect.value);
            }
        }
        
        // Filter labs by search term and department
        function filterLabs() {
            const searchTerm = labSearch ? labSearch.value.toLowerCase() : '';
            const departmentValue = departmentFilter ? departmentFilter.value : 'all';
            let visibleCount = 0;
            
            labRows.forEach(row => {
                const labNameElement = row.querySelector('td:first-child span');
                const labName = labNameElement ? labNameElement.textContent.toLowerCase() : '';
                const labDepartments = row.dataset.department ? row.dataset.department.split(',').filter(d => d.trim() !== '') : [];
                
                const matchesSearch = !searchTerm || labName.includes(searchTerm);
                const matchesDepartment = departmentValue === 'all' || labDepartments.includes(departmentValue);
                
                if (matchesSearch && matchesDepartment) {
                    row.classList.remove('d-none');
                    visibleCount++;
                } else {
                    row.classList.add('d-none');
                }
            });
            
            // Show "no labs found" message if no results
            if (noLabsFound) {
                if (visibleCount === 0) {
                    noLabsFound.classList.remove('d-none');
                } else {
                    noLabsFound.classList.add('d-none');
                }
            }
        }
        
        // Select a lab
        function selectLab(row) {
            // Remove previous selection
            labRows.forEach(r => r.classList.remove('selected'));
            
            // Add new selection
            row.classList.add('selected');
            
            // Update hidden select field
            const labId = row.dataset.laboratoryId;
            if (labSelect) {
                labSelect.value = labId;
            }
            
            // Update the lab info section
            const labName = row.querySelector('td:first-child span').textContent;
            const labDepartment = row.querySelector('td:nth-child(2)').textContent;
            const labCapacity = row.querySelector('td:nth-child(3)').textContent;
            
            selectedLabName.textContent = labName;
            selectedLabDetails.textContent = `${labDepartment} | ${labCapacity}`;
            
            // Show the selected lab info
            selectedLabInfo.classList.remove('d-none');
            
            // Hide the table for a cleaner UI
            document.querySelector('.table-responsive').classList.add('d-none');
            
            // Load laboratory materials
            loadLaboratoryMaterials(labId);
        }
        
        // Load laboratory materials
        function loadLaboratoryMaterials(labId) {
            const materialsSection = document.getElementById('laboratoryMaterialsSection');
            const materialsList = document.getElementById('materialsList');
            
            if (!labId) {
                materialsSection.style.display = 'none';
                return;
            }
            
            // Show loading state
            materialsList.innerHTML = `
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando materiais...</p>
                </div>
            `;
            
            materialsSection.style.display = 'block';
            
            // Fetch materials from API
            fetch(`/scheduling/api/laboratory-materials/${labId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.materials && data.materials.length > 0) {
                        renderMaterials(data.materials);
                    } else {
                        materialsList.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="bi bi-box-seam fs-1"></i>
                                <p>Nenhum material cadastrado neste laboratório</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading materials:', error);
                    materialsList.innerHTML = `
                        <div class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                            <p>Erro ao carregar materiais</p>
                        </div>
                    `;
                });
        }
        
        // Render materials list
        function renderMaterials(materials) {
            const materialsList = document.getElementById('materialsList');
            currentLabMaterials = materials; // Store current materials for search
            
            let html = '<div class="row">';
            
            materials.forEach(material => {
                const stockClass = material.is_low_stock ? 'text-danger' : 'text-success';
                const stockIcon = material.is_low_stock ? 'exclamation-triangle' : 'check-circle';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card material-card h-100">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="selected_materials" value="${material.id}" 
                                           id="material_${material.id}">
                                    <label class="form-check-label" for="material_${material.id}">
                                        <strong>${material.name}</strong>
                                    </label>
                                </div>
                                <p class="small text-muted mb-2">${material.description || 'Sem descrição'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="badge bg-light text-dark">${material.category}</small>
                                    <small class="${stockClass}">
                                        <i class="bi bi-${stockIcon} me-1"></i>
                                        ${material.quantity}/${material.minimum_stock}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            materialsList.innerHTML = html;
        }
        
        // Material search functionality
        const materialSearch = document.getElementById('materialSearch');
        const searchAllLabsBtn = document.getElementById('searchAllLabsBtn');
        let currentLabMaterials = [];
        
        // Search materials within current laboratory
        if (materialSearch) {
            materialSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterMaterials(currentLabMaterials, searchTerm);
            });
        }
        
        // Search materials across all laboratories
        if (searchAllLabsBtn) {
            searchAllLabsBtn.addEventListener('click', function() {
                const searchTerm = materialSearch.value.toLowerCase();
                if (searchTerm.length < 2) {
                    alert('Digite pelo menos 2 caracteres para buscar');
                    return;
                }
                searchAllLaboratories(searchTerm);
            });
        }
        
        function filterMaterials(materials, searchTerm) {
            if (!searchTerm) {
                renderMaterials(materials);
                return;
            }
            
            const filtered = materials.filter(material => 
                material.name.toLowerCase().includes(searchTerm) ||
                (material.description && material.description.toLowerCase().includes(searchTerm))
            );
            renderMaterials(filtered);
        }
        
        function searchAllLaboratories(searchTerm) {
            const materialsList = document.getElementById('materialsList');
            
            materialsList.innerHTML = `
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Buscando...</span>
                    </div>
                    <p class="mt-2">Buscando em todos os laboratórios...</p>
                </div>
            `;
            
            // Simular busca cross-laboratory (implementar API depois)
            setTimeout(() => {
                materialsList.innerHTML = `
                    <div class="text-center text-info">
                        <i class="bi bi-lightbulb fs-1"></i>
                        <p>Funcionalidade de busca cross-laboratory em desenvolvimento</p>
                        <p class="small">Em breve você poderá buscar materiais em todos os laboratórios</p>
                    </div>
                `;
            }, 1000);
        }
        
        // Add event listeners
        if (labSearch) {
            labSearch.addEventListener('input', filterLabs);
        }
        
        if (departmentFilter) {
            departmentFilter.addEventListener('change', filterLabs);
        }
        
        // Initialize filters
        filterLabs();
        
        // Event listener for lab selection
        labRows.forEach((row, index) => {
            const selectBtn = row.querySelector('.select-lab-btn');
            
            if (selectBtn) {
                // Select on button click
                selectBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectLab(row);
                });
            }
            
            // Also select on row click
            row.addEventListener('click', function() {
                selectLab(this);
            });
        });
        
        // Change lab button
        if (changeLabBtn) {
            changeLabBtn.addEventListener('click', function() {
                // Show the table again
                document.querySelector('.table-responsive').classList.remove('d-none');
                // Hide the selected lab info
                selectedLabInfo.classList.add('d-none');
            });
        }
        
        // Drag and drop file upload
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('id_attachments');
        const filePreview = document.getElementById('filePreview');
        
        if (dropArea && fileInput) {
            // Click em qualquer lugar da área para selecionar arquivos
            dropArea.addEventListener('click', function(e) {
                if (e.target.id !== 'id_attachments') {
                    fileInput.click();
                }
            });
            
            // Eventos de drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('border-primary');
                dropArea.style.backgroundColor = 'rgba(74, 111, 165, 0.05)';
            }
            
            function unhighlight() {
                dropArea.classList.remove('border-primary');
                dropArea.style.backgroundColor = '';
            }
            
            // Processar arquivos carregados
            dropArea.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFiles, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files;
                handleFiles();
            }
            
            function handleFiles() {
                const files = fileInput.files;
                filePreview.innerHTML = '';
                
                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        
                        // Identificar ícone com base no tipo de arquivo
                        let fileIcon = 'bi-file';
                        if (file.type.includes('image')) {
                            fileIcon = 'bi-file-image';
                        } else if (file.type.includes('pdf')) {
                            fileIcon = 'bi-file-pdf';
                        } else if (file.type.includes('word')) {
                            fileIcon = 'bi-file-word';
                        } else if (file.type.includes('text')) {
                            fileIcon = 'bi-file-text';
                        }
                        
                        fileItem.innerHTML = `
                            <i class="bi ${fileIcon}"></i>
                            <span>${file.name}</span>
                        `;
                        filePreview.appendChild(fileItem);
                    });
                }
            }
        }
        
        // Data de agendamento - validar apenas no backend
        // JavaScript removido para evitar conflitos com validação do servidor
        
        // Form submission confirmation
        const form = document.getElementById('scheduleRequestForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Verificar se um laboratório foi selecionado
                if (!labSelect.value) {
                    e.preventDefault();
                    alert('Por favor, selecione um laboratório antes de prosseguir.');
                    return;
                }
                
                const isConfirmationDay = {{ is_confirmation_day|yesno:"true,false" }};
                
                // Nota: Validação de domingos feita apenas no evento 'input' acima
                
                if (!isConfirmationDay) {
                    const confirmMessage = 'Tem certeza que deseja salvar este agendamento como rascunho? ' +
                                         'Você só poderá confirmá-lo na próxima quinta ou sexta-feira.';
                    
                    if (!confirm(confirmMessage)) {
                        e.preventDefault();
                    } else {
                        // Adicionar efeito de loading no botão
                        const submitBtn = form.querySelector('button[type="submit"]');
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Salvando...';
                        submitBtn.disabled = true;
                    }
                } else {
                    // Adicionar efeito de loading no botão
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Enviando...';
                    submitBtn.disabled = true;
                }
            });
        }
        
        // ===== CÓDIGO PARA MODO DE EDIÇÃO =====
        {% if is_edit and draft_request %}
        console.log('🔧 Modo de edição ativado - carregando dados do rascunho');
        
        // Se já há um laboratório selecionado, carregar seus materiais e marcar os selecionados
        const currentLabId = {{ draft_request.laboratory.id|default:"null" }};
        if (currentLabId) {
            console.log(`🏢 Laboratório do rascunho: ${currentLabId}`);
            
            // Carregar materiais do laboratório automaticamente
            loadLaboratoryMaterials(currentLabId);
            
            // Aguardar um pouco para os materiais carregarem, então marcar os selecionados
            setTimeout(() => {
                console.log('📦 Marcando materiais selecionados...');
                
                // Marcar materiais que estavam selecionados
                const selectedMaterialIds = {{ form.initial.selected_materials|default:"[]"|safe }};
                console.log('📦 IDs de materiais para marcar:', selectedMaterialIds);
                
                selectedMaterialIds.forEach(materialId => {
                    const checkbox = document.querySelector(`input[name="selected_materials"][value="${materialId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✅ Material ${materialId} marcado`);
                    } else {
                        console.warn(`⚠️ Checkbox para material ${materialId} não encontrado`);
                    }
                });
            }, 1000); // Aguardar 1 segundo para os materiais carregarem
            
            // Mostrar informações do laboratório selecionado
            const labRow = document.querySelector(`tr[data-lab-id="${currentLabId}"]`);
            if (labRow) {
                selectLab(labRow);
                console.log('🏢 Laboratório pré-selecionado no formulário');
            }
        }
        
        // Modificar mensagem do botão para modo de edição
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="bi bi-pencil-square me-2"></i>Atualizar Rascunho';
        }
        
        console.log('✅ Modo de edição configurado com sucesso');
        {% endif %}
    });
</script>
{% endblock %}