{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load scheduling_filters %}

{% block title %}Solicitar Agendamento | LabConnect{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/create-request-optimized.css' %}">
<style>
.materials-grid {
    max-height: 400px;
    overflow-y: auto;
}

.list-group-item:hover {
    background-color: var(--bs-light);
}

.form-check-input:checked ~ .form-check-label {
    font-weight: bold;
    color: #007bff;
}

.list-group-item .form-check {
    margin-bottom: 0;
}

.list-group-item .form-check-label {
    cursor: pointer;
    margin-bottom: 0;
}

/* Material list specific styles */
#materialsList .list-group-item {
    padding: 0.75rem 1rem;
    border-left: none;
    border-right: none;
}

#materialsList .list-group-item:first-child {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}

#materialsList .list-group-item:last-child {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

/* Cores espec√≠ficas dos laborat√≥rios */
.text-purple {
    color: #6f42c1 !important; /* Bootstrap purple */
}
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="page-title">
                    {% if is_edit %}
                        {{ title|default:"Editar Rascunho de Agendamento" }}
                    {% else %}
                        Solicitar Agendamento
                    {% endif %}
                </h1>
                <p class="page-subtitle">
                    {% if is_edit %}
                        Modifique os dados do seu rascunho de agendamento
                    {% else %}
                        Agende um laborat√≥rio para sua aula
                    {% endif %}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="{% url 'professor_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Scheduling Information -->
    <div class="draft-warning d-flex align-items-center mb-4">
        <div class="draft-warning-icon">
            <i class="bi bi-{% if is_confirmation_day %}calendar-check{% else %}info-circle{% endif %}"></i>
        </div>
        <div>
            {% if is_confirmation_day and not is_edit %}
                <h5 class="mb-2">Op√ß√µes de Agendamento</h5>
                <p class="mb-0">
                    <strong>Rascunho:</strong> Agende para qualquer dia do m√™s (exceto domingos) e confirme depois.<br>
                    <strong>Envio Direto:</strong> Envie solicita√ß√£o para a pr√≥xima semana (segunda a s√°bado).
                    <a href="{% url 'view_draft_schedule_requests' %}" class="alert-link">
                        Ver meus rascunhos
                    </a>
                </p>
            {% elif not is_edit %}
                <h5 class="mb-2">Modo Rascunho</h5>
                <p class="mb-0">
                    Salve um rascunho para qualquer dia do m√™s (exceto domingos). Poder√° confirm√°-lo na quinta ou sexta-feira.
                    <a href="{% url 'view_draft_schedule_requests' %}" class="alert-link">
                        Ver meus rascunhos
                    </a>
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Scheduling Request Container -->
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="schedule-request-container">
                <!-- Informative Alert -->
                <div class="alert alert-info m-3" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    {% if is_confirmation_day and not is_edit %}
                        Escolha: <strong>Rascunho</strong> (qualquer dia do m√™s) ou <strong>Envio Direto</strong> (apenas pr√≥xima semana)
                    {% elif is_edit %}
                        Editando rascunho de agendamento
                    {% else %}
                        Criando rascunho de agendamento para qualquer dia do m√™s (exceto domingos)
                    {% endif %}
                </div>

                <!-- Request Form -->
                <form method="post" id="scheduleRequestForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Hidden lab selection field -->
                    {{ form.laboratory.as_hidden }}

                    <div class="request-body">
                        <!-- Laboratory Selection -->
                        <div class="form-section mb-5 laboratory-suggestion">
                            <h5><i class="bi bi-geo-alt me-2"></i>Selecione o Laborat√≥rio</h5>
                            
                            <div class="mb-4">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                                            <input type="text" id="labSearch" class="form-control" placeholder="Buscar laborat√≥rio...">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <select id="departmentFilter" class="form-select">
                                            <option value="all">Todos os departamentos</option>
                                            {% for dept in departments %}
                                                <option value="{{ dept.code }}">{{ dept.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lab-selection-container">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Laborat√≥rio</th>
                                                <th>Departamento</th>
                                                <th>Capacidade</th>
                                                <th>A√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody id="labsTableBody">
                                            {% for laboratory in form.laboratory.field.queryset %}
                                            <tr class="lab-row" data-laboratory-id="{{ laboratory.id }}" data-department="{{ laboratory|department_codes|join:',' }}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="lab-icon me-2">
                                                            <i class="bi bi-building text-primary"></i>
                                                        </div>
                                                        <span>{{ laboratory.name }}</span>
                                                    </div>
                                                </td>
                                                <td>{{ laboratory.get_departments_display }}</td>
                                                <td>{{ laboratory.capacity }} pessoas</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-outline-primary select-lab-btn">
                                                        Selecionar
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-3">
                                                    <i class="bi bi-building"></i>
                                                    <p class="mb-0">Nenhum laborat√≥rio dispon√≠vel</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div id="noLabsFound" class="text-center py-4 d-none">
                                    <i class="bi bi-search text-muted" style="font-size: 2rem;"></i>
                                    <h6 class="mt-3 mb-0">Nenhum laborat√≥rio encontrado</h6>
                                    <p class="text-muted">Tente outro termo de busca ou filtro</p>
                                </div>
                                
                                <div id="selectedLabInfo" class="mt-4 p-3 rounded d-none">
                                    <div class="d-flex align-items-start">
                                        <div class="selected-lab-icon me-3 p-3 rounded">
                                            <i class="bi bi-building-check fs-1"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">Laborat√≥rio selecionado:</h6>
                                            <h5 id="selectedLabName" class="mb-2">Nome do laborat√≥rio</h5>
                                            <p id="selectedLabDetails" class="mb-0 text-muted">Departamento | Capacidade: x pessoas</p>
                                        </div>
                                        <button type="button" id="changeLabBtn" class="btn btn-sm btn-outline-secondary ms-auto">
                                            <i class="bi bi-pencil"></i> Alterar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resto do formul√°rio permanece inalterado -->
                        <!-- Basic Information -->
                        <div class="form-section mb-5">
                            <h5><i class="bi bi-info-circle me-2"></i>Informa√ß√µes B√°sicas</h5>
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.subject.id_for_label }}" class="form-label">Disciplina/Assunto</label>
                                    {{ form.subject }}
                                    <div class="form-text">Informe a disciplina ou o assunto da aula</div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.scheduled_date.id_for_label }}" class="form-label">Data Agendada</label>
                                    {{ form.scheduled_date }}
                                    <div class="form-text">
                                        <strong>Rascunho:</strong> Qualquer dia do m√™s (exceto domingos)<br>
                                        <strong>Envio Direto:</strong> Apenas pr√≥xima semana (segunda a s√°bado)
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="id_shift" class="form-label">Turno</label>
                                    {{ form.shift }}
                                    <div class="form-text">Escolha o per√≠odo do dia para sua aula</div>
                                </div>
                                
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.number_of_students.id_for_label }}" class="form-label">N√∫mero de Alunos</label>
                                    {{ form.number_of_students }}
                                    <div class="form-text">Quantidade de alunos que participar√£o da aula</div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="{{ form.class_semester.id_for_label }}" class="form-label">Semestre/Turma</label>
                                    {{ form.class_semester }}
                                    <div class="form-text">Identifica√ß√£o do semestre ou turma</div>
                                </div>
                            </div>
                        </div>

                        <!-- Description and Materials -->
                        <div class="form-section mb-5">
                            <h5><i class="bi bi-file-text me-2"></i>Detalhes da Atividade</h5>
                            <div class="mb-4">
                                <label for="{{ form.description.id_for_label }}" class="form-label">Descri√ß√£o da Atividade <span class="text-muted">(opcional)</span></label>
                                {{ form.description }}
                            </div>
                            
                            <div class="mb-4">
                                <label for="{{ form.materials.id_for_label }}" class="form-label">Materiais Necess√°rios (Descri√ß√£o)</label>
                                {{ form.materials }}
                            </div>
                            
                            <!-- Sele√ß√£o de Materiais do Laborat√≥rio -->
                            <div class="mb-4" id="laboratoryMaterialsSection" style="display: none;">
                                <label class="form-label">Materiais Dispon√≠veis no Laborat√≥rio</label>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Selecione os materiais que voc√™ pretende usar na aula.
                                </div>
                                
                                <!-- Busca de Materiais -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" id="materialSearch" class="form-control" placeholder="Buscar materiais...">
                                        <button type="button" class="btn btn-outline-secondary" id="searchAllLabsBtn">
                                            <i class="bi bi-search me-1"></i>Buscar em Todos os Labs
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="materialsList" class="materials-grid">
                                    <div class="text-center text-muted">
                                        <i class="bi bi-box-seam fs-1"></i>
                                        <p>Selecione um laborat√≥rio para ver os materiais dispon√≠veis</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attachments Section -->
                        <div class="form-section">
                            <h5><i class="bi bi-paperclip me-2"></i>Roteiro de Aula (Opcional)</h5>
                            
                            <!-- Mostrar arquivo existente se estiver editando -->
                            {% if is_edit and draft_request.guide_file %}
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-file-earmark me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>Arquivo atual:</strong> {{ draft_request.guide_file.name|basename }}
                                        <small class="d-block text-muted">Voc√™ pode substituir este arquivo anexando um novo abaixo</small>
                                    </div>
                                    <a href="{{ draft_request.guide_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye me-1"></i>Visualizar
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                {{ form.guide_file.label_tag }}
                                {{ form.guide_file }}
                                {% if form.guide_file.help_text %}
                                <div class="form-text">{{ form.guide_file.help_text }}</div>
                                {% endif %}
                                {% if form.guide_file.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.guide_file.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Request Footer -->
                    <div class="request-footer">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <a href="{% url 'professor_dashboard' %}" class="btn btn-outline-secondary mb-2 mb-md-0">
                                <i class="bi bi-x-lg me-1"></i> Cancelar
                            </a>
                            
                            <div class="d-flex gap-2 flex-wrap">
                                {% if is_confirmation_day and not is_edit %}
                                    <!-- Quinta/Sexta: mostrar ambos os bot√µes -->
                                    <button type="submit" name="save_as_draft" value="true" class="btn btn-outline-primary mb-2 mb-md-0">
                                        <i class="bi bi-save me-1"></i> Salvar Rascunho
                                    </button>
                                    <button type="submit" name="save_as_draft" value="false" class="btn btn-primary">
                                        <i class="bi bi-calendar-plus me-1"></i> Enviar Agendamento
                                    </button>
                                {% elif is_edit %}
                                    <!-- Modo edi√ß√£o: apenas salvar -->
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-pencil-square me-1"></i> Atualizar Rascunho
                                    </button>
                                {% else %}
                                    <!-- Outros dias: apenas rascunho -->
                                    <button type="submit" name="save_as_draft" value="true" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i> Salvar Rascunho
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // ===== FUN√á√ÉO PARA √çCONES E CORES DOS LABORAT√ìRIOS =====
        function getLabIcon(departmentCodes) {
            // Converter string de c√≥digos para array
            const codes = typeof departmentCodes === 'string' ? departmentCodes.split(',').map(c => c.trim()) : [];
            
            // Se tem m√∫ltiplos departamentos, usar √≠cone de disciplinariedade
            if (codes.length > 1) {
                return 'bi-diagram-3'; // √çcone para m√∫ltiplas disciplinas
            }
            
            // √çcone espec√≠fico por departamento
            const iconMap = {
                'exatas': 'bi-calculator',     // √çcone para exatas
                'saude': 'bi-heart-pulse',     // √çcone para sa√∫de
                'informatica': 'bi-cpu'        // √çcone para inform√°tica
            };
            
            return iconMap[codes[0]] || 'bi-building'; // Fallback para o √≠cone padr√£o
        }
        
        function getLabColor(departmentCodes) {
            // Converter string de c√≥digos para array
            const codes = typeof departmentCodes === 'string' ? departmentCodes.split(',').map(c => c.trim()) : [];
            
            // Se tem m√∫ltiplos departamentos, usar cor roxa
            if (codes.length > 1) {
                return 'text-purple'; // Roxo para interdisciplinar
            }
            
            // Cor espec√≠fica por departamento
            const colorMap = {
                'exatas': 'text-primary',      // Azul para exatas (mant√©m)
                'saude': 'text-danger',        // Vermelho para sa√∫de
                'informatica': 'text-success'  // Verde para inform√°tica
            };
            
            return colorMap[codes[0]] || 'text-primary'; // Fallback para azul
        }
        
        // Aplicar √≠cones e cores espec√≠ficos aos laborat√≥rios
        function updateLabIcons() {
            const labRows = document.querySelectorAll('.lab-row');
            labRows.forEach(row => {
                const departmentCodes = row.dataset.department || '';
                const icon = row.querySelector('.lab-icon i');
                if (icon) {
                    // Remover classes de √≠cone e cor existentes
                    icon.className = icon.className.replace(/bi-[a-z0-9\-]+/g, '').replace(/text-[a-z]+/g, '');
                    // Adicionar novo √≠cone e cor
                    const newIconClass = getLabIcon(departmentCodes);
                    const newColorClass = getLabColor(departmentCodes);
                    icon.classList.add(newIconClass, newColorClass);
                }
            });
        }
        
        // Atualizar √≠cones quando a p√°gina carregar
        updateLabIcons();
        // Laboratory Selection
        const labSelect = document.getElementById('id_laboratory');
        const labRows = document.querySelectorAll('.lab-row');
        const labSearch = document.getElementById('labSearch');
        const departmentFilter = document.getElementById('departmentFilter');
        const selectedLabInfo = document.getElementById('selectedLabInfo');
        const selectedLabName = document.getElementById('selectedLabName');
        const selectedLabDetails = document.getElementById('selectedLabDetails');
        const changeLabBtn = document.getElementById('changeLabBtn');
        const noLabsFound = document.getElementById('noLabsFound');
        const labsTableBody = document.getElementById('labsTableBody');
        
        // Show selected lab if one is already selected
        if (labSelect && labSelect.value) {
            const selectedRow = document.querySelector(`.lab-row[data-laboratory-id="${labSelect.value}"]`);
            if (selectedRow) {
                selectLab(selectedRow);
                loadLaboratoryMaterials(labSelect.value);
            }
        }
        
        // Filter labs by search term and department
        function filterLabs() {
            const searchTerm = labSearch ? labSearch.value.toLowerCase() : '';
            const departmentValue = departmentFilter ? departmentFilter.value : 'all';
            let visibleCount = 0;
            
            labRows.forEach(row => {
                const labNameElement = row.querySelector('td:first-child span');
                const labName = labNameElement ? labNameElement.textContent.toLowerCase() : '';
                const labDepartments = row.dataset.department ? row.dataset.department.split(',').filter(d => d.trim() !== '') : [];
                
                const matchesSearch = !searchTerm || labName.includes(searchTerm);
                const matchesDepartment = departmentValue === 'all' || labDepartments.includes(departmentValue);
                
                if (matchesSearch && matchesDepartment) {
                    row.classList.remove('d-none');
                    visibleCount++;
                } else {
                    row.classList.add('d-none');
                }
            });
            
            // Show "no labs found" message if no results
            if (noLabsFound) {
                if (visibleCount === 0) {
                    noLabsFound.classList.remove('d-none');
                } else {
                    noLabsFound.classList.add('d-none');
                }
            }
        }
        
        // Select a lab
        function selectLab(row) {
            // Remove previous selection
            labRows.forEach(r => r.classList.remove('selected'));
            
            // Add new selection
            row.classList.add('selected');
            
            // Update hidden select field
            const labId = row.dataset.laboratoryId;
            if (labSelect) {
                labSelect.value = labId;
            }
            
            // Update the lab info section
            const labName = row.querySelector('td:first-child span').textContent;
            const labDepartment = row.querySelector('td:nth-child(2)').textContent;
            const labCapacity = row.querySelector('td:nth-child(3)').textContent;
            
            selectedLabName.textContent = labName;
            selectedLabDetails.textContent = `${labDepartment} | ${labCapacity}`;
            
            // Update the selected lab icon
            const selectedLabIcon = document.querySelector('#selectedLabInfo .selected-lab-icon i');
            if (selectedLabIcon) {
                const departmentCodes = row.dataset.department || '';
                selectedLabIcon.className = selectedLabIcon.className.replace(/bi-[a-z0-9\-]+/g, '').replace(/text-[a-z]+/g, '');
                const newIconClass = getLabIcon(departmentCodes);
                const newColorClass = getLabColor(departmentCodes);
                selectedLabIcon.classList.add(newIconClass, newColorClass, 'fs-1');
            }
            
            // Show the selected lab info
            selectedLabInfo.classList.remove('d-none');
            
            // Hide the table for a cleaner UI
            document.querySelector('.table-responsive').classList.add('d-none');
            
            // Load laboratory materials
            loadLaboratoryMaterials(labId);
        }
        
        // Load laboratory materials
        function loadLaboratoryMaterials(labId) {
            const materialsSection = document.getElementById('laboratoryMaterialsSection');
            const materialsList = document.getElementById('materialsList');
            
            if (!labId) {
                materialsSection.style.display = 'none';
                return;
            }
            
            // Show loading state
            materialsList.innerHTML = `
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando materiais...</p>
                </div>
            `;
            
            materialsSection.style.display = 'block';
            
            // Fetch materials from API
            fetch(`/scheduling/api/laboratory-materials/${labId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.materials && data.materials.length > 0) {
                        renderMaterials(data.materials);
                    } else {
                        materialsList.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="bi bi-box-seam fs-1"></i>
                                <p>Nenhum material cadastrado neste laborat√≥rio</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading materials:', error);
                    materialsList.innerHTML = `
                        <div class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                            <p>Erro ao carregar materiais</p>
                        </div>
                    `;
                });
        }
        
        // Render materials list
        function renderMaterials(materials) {
            const materialsList = document.getElementById('materialsList');
            currentLabMaterials = materials; // Store current materials for search
            
            let html = '<div class="list-group">';
            
            materials.forEach(material => {
                const stockClass = material.is_low_stock ? 'text-danger' : 'text-success';
                const stockIcon = material.is_low_stock ? 'exclamation-triangle' : 'check-circle';
                
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex align-items-center">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" 
                                       name="selected_materials" value="${material.id}" 
                                       id="material_${material.id}">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <label class="form-check-label fw-bold mb-1" for="material_${material.id}">
                                            ${material.name}
                                        </label>
                                        <div class="small text-muted">${material.description || 'Sem descri√ß√£o'}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="small">
                                            <span class="badge bg-light text-dark me-2">${material.category}</span>
                                            <span class="${stockClass}">
                                                <i class="bi bi-${stockIcon} me-1"></i>
                                                ${material.quantity}/${material.minimum_stock}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            materialsList.innerHTML = html;
        }
        
        // Material search functionality
        const materialSearch = document.getElementById('materialSearch');
        const searchAllLabsBtn = document.getElementById('searchAllLabsBtn');
        let currentLabMaterials = [];
        
        // Search materials within current laboratory
        if (materialSearch) {
            materialSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterMaterials(currentLabMaterials, searchTerm);
            });
        }
        
        // Search materials across all laboratories
        if (searchAllLabsBtn) {
            searchAllLabsBtn.addEventListener('click', function() {
                const searchTerm = materialSearch.value.toLowerCase();
                if (searchTerm.length < 2) {
                    alert('Digite pelo menos 2 caracteres para buscar');
                    return;
                }
                searchAllLaboratories(searchTerm);
            });
        }
        
        function filterMaterials(materials, searchTerm) {
            if (!searchTerm) {
                renderMaterials(materials);
                return;
            }
            
            const filtered = materials.filter(material => 
                material.name.toLowerCase().includes(searchTerm) ||
                (material.description && material.description.toLowerCase().includes(searchTerm))
            );
            renderMaterials(filtered);
        }
        
        function searchAllLaboratories(searchTerm) {
            const materialsList = document.getElementById('materialsList');
            
            materialsList.innerHTML = `
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Buscando...</span>
                    </div>
                    <p class="mt-2">Buscando em todos os laborat√≥rios...</p>
                </div>
            `;
            
            // Simular busca cross-laboratory (implementar API depois)
            setTimeout(() => {
                materialsList.innerHTML = `
                    <div class="text-center text-info">
                        <i class="bi bi-lightbulb fs-1"></i>
                        <p>Funcionalidade de busca cross-laboratory em desenvolvimento</p>
                        <p class="small">Em breve voc√™ poder√° buscar materiais em todos os laborat√≥rios</p>
                    </div>
                `;
            }, 1000);
        }
        
        // Add event listeners
        if (labSearch) {
            labSearch.addEventListener('input', filterLabs);
        }
        
        if (departmentFilter) {
            departmentFilter.addEventListener('change', filterLabs);
        }
        
        // Initialize filters
        filterLabs();
        
        // Event listener for lab selection
        labRows.forEach((row, index) => {
            const selectBtn = row.querySelector('.select-lab-btn');
            
            if (selectBtn) {
                // Select on button click
                selectBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectLab(row);
                });
            }
            
            // Also select on row click
            row.addEventListener('click', function() {
                selectLab(this);
            });
        });
        
        // Change lab button
        if (changeLabBtn) {
            changeLabBtn.addEventListener('click', function() {
                // Show the table again
                document.querySelector('.table-responsive').classList.remove('d-none');
                // Hide the selected lab info
                selectedLabInfo.classList.add('d-none');
            });
        }
        
        // Drag and drop file upload
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('id_attachments');
        const filePreview = document.getElementById('filePreview');
        
        if (dropArea && fileInput) {
            // Click em qualquer lugar da √°rea para selecionar arquivos
            dropArea.addEventListener('click', function(e) {
                if (e.target.id !== 'id_attachments') {
                    fileInput.click();
                }
            });
            
            // Eventos de drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('border-primary');
                dropArea.style.backgroundColor = 'rgba(74, 111, 165, 0.05)';
            }
            
            function unhighlight() {
                dropArea.classList.remove('border-primary');
                dropArea.style.backgroundColor = '';
            }
            
            // Processar arquivos carregados
            dropArea.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFiles, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files;
                handleFiles();
            }
            
            function handleFiles() {
                const files = fileInput.files;
                filePreview.innerHTML = '';
                
                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        
                        // Identificar √≠cone com base no tipo de arquivo
                        let fileIcon = 'bi-file';
                        if (file.type.includes('image')) {
                            fileIcon = 'bi-file-image';
                        } else if (file.type.includes('pdf')) {
                            fileIcon = 'bi-file-pdf';
                        } else if (file.type.includes('word')) {
                            fileIcon = 'bi-file-word';
                        } else if (file.type.includes('text')) {
                            fileIcon = 'bi-file-text';
                        }
                        
                        fileItem.innerHTML = `
                            <i class="bi ${fileIcon}"></i>
                            <span>${file.name}</span>
                        `;
                        filePreview.appendChild(fileItem);
                    });
                }
            }
        }
        
        // Data de agendamento - validar apenas no backend
        // JavaScript removido para evitar conflitos com valida√ß√£o do servidor
        
        // Form submission confirmation
        const form = document.getElementById('scheduleRequestForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Verificar se um laborat√≥rio foi selecionado
                if (!labSelect.value) {
                    e.preventDefault();
                    alert('Por favor, selecione um laborat√≥rio antes de prosseguir.');
                    return;
                }
                
                const isConfirmationDay = {% if is_confirmation_day %}true{% else %}false{% endif %};
                
                // Nota: Valida√ß√£o de domingos feita apenas no evento 'input' acima
                
                // Determinar qual bot√£o foi clicado
                const clickedButton = e.submitter;
                const isDraft = clickedButton && clickedButton.getAttribute('name') === 'save_as_draft' && clickedButton.value === 'true';
                
                if (isDraft) {
                    const message = isConfirmationDay ? 
                        'Tem certeza que deseja salvar como rascunho? Voc√™ pode confirm√°-lo depois.' :
                        'Tem certeza que deseja salvar este agendamento como rascunho? Voc√™ s√≥ poder√° confirm√°-lo na pr√≥xima quinta ou sexta-feira.';
                    
                    if (!confirm(message)) {
                        e.preventDefault();
                        return;
                    }
                    
                    // Adicionar efeito de loading no bot√£o de rascunho
                    clickedButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Salvando...';
                    clickedButton.disabled = true;
                } else {
                    // Adicionar efeito de loading no bot√£o de envio
                    if (clickedButton) {
                        clickedButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Enviando...';
                        clickedButton.disabled = true;
                    }
                }
            });
        }
        
        // ===== C√ìDIGO PARA MODO DE EDI√á√ÉO =====
        {% if is_edit and draft_request %}
        console.log('üîß Modo de edi√ß√£o ativado - carregando dados do rascunho');
        
        // Se j√° h√° um laborat√≥rio selecionado, carregar seus materiais e marcar os selecionados
        const currentLabId = {{ draft_request.laboratory.id|default:"null" }};
        if (currentLabId) {
            console.log(`üè¢ Laborat√≥rio do rascunho: ${currentLabId}`);
            
            // Carregar materiais do laborat√≥rio automaticamente
            loadLaboratoryMaterials(currentLabId);
            
            // Aguardar um pouco para os materiais carregarem, ent√£o marcar os selecionados
            setTimeout(() => {
                console.log('üì¶ Marcando materiais selecionados...');
                
                // Marcar materiais que estavam selecionados
                const selectedMaterialIds = {{ form.initial.selected_materials|default:"[]"|safe }};
                console.log('üì¶ IDs de materiais para marcar:', selectedMaterialIds);
                
                selectedMaterialIds.forEach(materialId => {
                    const checkbox = document.querySelector(`input[name="selected_materials"][value="${materialId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`‚úÖ Material ${materialId} marcado`);
                    } else {
                        console.warn(`‚ö†Ô∏è Checkbox para material ${materialId} n√£o encontrado`);
                    }
                });
            }, 1000); // Aguardar 1 segundo para os materiais carregarem
            
            // Mostrar informa√ß√µes do laborat√≥rio selecionado
            const labRow = document.querySelector(`tr[data-lab-id="${currentLabId}"]`);
            if (labRow) {
                selectLab(labRow);
                console.log('üè¢ Laborat√≥rio pr√©-selecionado no formul√°rio');
            }
        }
        
        // Modificar mensagem do bot√£o para modo de edi√ß√£o
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="bi bi-pencil-square me-2"></i>Atualizar Rascunho';
        }
        
        console.log('‚úÖ Modo de edi√ß√£o configurado com sucesso');
        {% endif %}
        
        // ===== ADICIONAR PLACEHOLDERS AOS CAMPOS =====
        // Adicionar placeholders diretamente no HTML
        const fieldPlaceholders = {
            'id_subject': 'Ex: F√≠sica I, Qu√≠mica Org√¢nica, Matem√°tica...',
            'id_number_of_students': 'Ex: 25',
            'id_class_semester': 'Ex: 1¬∫ Semestre, 3¬∫ Per√≠odo, Turma A',
            'id_description': 'Descreva brevemente a atividade que ser√° realizada na aula...',
            'id_materials': 'Liste os materiais necess√°rios para a aula: microsc√≥pios, reagentes, equipamentos espec√≠ficos...'
        };
        
        // Aplicar placeholders
        Object.keys(fieldPlaceholders).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.setAttribute('placeholder', fieldPlaceholders[fieldId]);
            }
        });
    });
</script>
{% endblock %}