{% load static %}
<!DOCTYPE html>
<html lang="pt-BR" data-theme="ligth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="LabConnect - Sistema de Gestão de Laboratórios para Faculdade Unopar-Anhanguera">
    <meta name="author" content="LabConnectTeam">
    
    <title>{% block title %}LabConnect{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'img/logo.svg' %}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS Variables (deve vir primeiro) -->
    <link rel="stylesheet" href="{% static 'css/variables.css' %}">
    
    <!-- Base CSS Otimizado -->
    <link rel="stylesheet" href="{% static 'css/base-optimized.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatbot-optimized.css' %}">
    
    <!-- Dark Theme CSS (deve vir depois de outros) -->
    <link rel="stylesheet" href="{% static 'css/materials-dark-mode.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard-base.css' %}">
    <link rel="stylesheet" href="{% static 'css/dark-theme-override.css' %}">
    
    
    <!-- Page-specific CSS -->
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if user.is_authenticated and user.is_approved %}
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="{% url 'dashboard_redirect' %}" class="sidebar-logo">
                    <img src="{% static 'img/logo.svg' %}" alt="LabConnect Logo">
                    <span><span class="highlight">Lab</span>Connect</span>
                </a>
                <button type="button" class="sidebar-toggle d-lg-none" id="sidebarCollapseBtn">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="sidebar-menu">
                <div class="sidebar-heading">Principal</div>
                
                <div class="sidebar-item">
                    <a href="{% url 'dashboard_redirect' %}" class="sidebar-link {% if request.path == '/dashboard/' %}active{% endif %}">
                        <span class="sidebar-icon"><i class="bi bi-speedometer2"></i></span>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                {% if user.user_type == 'technician' %}
                    <!-- Laboratórios Dropdown -->
                    <div class="sidebar-item">
                        <a href="#" class="sidebar-link sidebar-dropdown-toggle {% if '/laboratories/' in request.path %}active{% endif %}" 
                        data-dropdown-target="laboratoriesSubmenu" 
                        aria-expanded="false">
                            <span class="sidebar-icon"><i class="bi bi-building"></i></span>
                            <span>Laboratórios</span>
                        </a>
                        <div class="sidebar-dropdown-menu {% if '/laboratories/' in request.path %}show{% endif %}" id="laboratoriesSubmenu">
                            <a href="{% url 'laboratory_list' %}" class="sidebar-dropdown-link {% if request.path == '/laboratories/' %}active{% endif %}">
                                Lista de Laboratórios
                            </a>
                            <a href="{% url 'laboratory_create' %}" class="sidebar-dropdown-link {% if '/laboratories/create/' in request.path %}active{% endif %}">
                                Adicionar Laboratório
                            </a>
                        </div>
                    </div>
                    
                    <!-- Estoque de Materiais Dropdown -->
                    <div class="sidebar-item">
                        <a href="#" class="sidebar-link sidebar-dropdown-toggle {% if '/inventory/' in request.path %}active{% endif %}" 
                        data-dropdown-target="inventorySubmenu" 
                        aria-expanded="false">
                            <span class="sidebar-icon"><i class="bi bi-box-seam"></i></span>
                            <span>Estoque de Materiais</span>
                        </a>
                        <div class="sidebar-dropdown-menu {% if '/inventory/' in request.path %}show{% endif %}" 
                            id="inventorySubmenu">
                            
                            <!-- Links que funcionam (views existem) -->
                            <a href="{% url 'material_list' %}" class="sidebar-dropdown-link {% if '/inventory/materials/' in request.path %}active{% endif %}">
                                <i class="bi bi-list-ul"></i> Materiais
                            </a>
                            <a href="{% url 'category_list' %}" class="sidebar-dropdown-link {% if '/inventory/categories/' in request.path %}active{% endif %}">
                                <i class="bi bi-tags"></i> Categorias
                            </a>
                            <a href="{% url 'import_materials' %}" class="sidebar-dropdown-link {% if '/inventory/import/' in request.path %}active{% endif %}">
                                <i class="bi bi-upload"></i> Importar Materiais
                            </a>
                            <a href="{% url 'ai_inventory_dashboard' %}" class="sidebar-dropdown-link {% if '/inventory/ai/' in request.path %}active{% endif %}">
                                <i class="bi bi-robot me-2"></i>IA Inventário
                            </a>

                        </div>
                    </div>
                    
                    <div class="sidebar-item">
                        <a href="{% url 'reports:reports_dashboard' %}" class="sidebar-link {% if '/reports/' in request.path %}active{% endif %}">
                            <span class="sidebar-icon"><i class="bi bi-graph-up"></i></span>
                            <span>Relatórios</span>
                        </a>
                    </div>
                    
                    <div class="sidebar-item">
                        <a href="{% url 'pending_approvals' %}" class="sidebar-link {% if '/pending-approvals/' in request.path %}active{% endif %}">
                            <span class="sidebar-icon"><i class="bi bi-person-plus"></i></span>
                            <span>Aprovações Pendentes</span>
                            {% if pending_count > 0 %}
                                <span class="sidebar-badge badge rounded-pill bg-danger">{{ pending_count }}</span>
                            {% endif %}
                        </a>
                    </div>
                    
                    <!-- Reset de Senhas (apenas para técnicos) -->
                    <div class="sidebar-item">
                        <a href="{% url 'password_reset_requests' %}" class="sidebar-link {% if '/password-reset-requests/' in request.path %}active{% endif %}">
                            <span class="sidebar-icon"><i class="bi bi-key"></i></span>
                            <span>Reset de Senhas</span>
                        </a>
                    </div>
                {% endif %}
                
                    <div class="sidebar-heading">Agendamentos</div>
        
                    <!-- Agendamentos Dropdown -->
                    <div class="sidebar-item">
                        <a href="#" class="sidebar-link sidebar-dropdown-toggle {% if '/scheduling/' in request.path %}active{% endif %}" 
                        data-dropdown-target="schedulingSubmenu" 
                        aria-expanded="{% if '/scheduling/' in request.path %}true{% else %}false{% endif %}">
                            <span class="sidebar-icon"><i class="bi bi-calendar-check"></i></span>
                            <span>Agendamentos</span>
                        </a>
                        <div class="sidebar-dropdown-menu {% if '/scheduling/' in request.path %}show{% endif %}" 
                            id="schedulingSubmenu">
                            <a href="{% url 'schedule_calendar' %}" class="sidebar-dropdown-link {% if '/scheduling/calendar/' in request.path %}active{% endif %}">
                                Calendário
                            </a>
                            {% if user.user_type == 'professor' %}
                                <a href="{% url 'create_schedule_request' %}" class="sidebar-dropdown-link {% if '/scheduling/request/' in request.path %}active{% endif %}">
                                    Solicitar Agendamento
                                </a>
                                <a href="{% url 'my_schedule_requests' %}" class="sidebar-dropdown-link {% if '/scheduling/my-requests/' in request.path %}active{% endif %}">
                                    Minhas Solicitações
                                </a>
                            {% else %}
                                <a href="{% url 'pending_requests' %}" class="sidebar-dropdown-link {% if '/scheduling/pending/' in request.path %}active{% endif %}">
                                    Solicitações
                                    {% if pending_requests_count > 0 %}
                                        <span class="badge rounded-pill bg-danger ms-1">{{ pending_requests_count }}</span>
                                    {% endif %}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                
                {% if user.user_type == 'professor' %}
                    <!-- Seção de Materiais para Professores -->
                    <div class="sidebar-item">
                        <a href="#" class="sidebar-link sidebar-dropdown-toggle {% if '/inventory/professor/' in request.path %}active{% endif %}" 
                        data-dropdown-target="materialsSubmenu" 
                        aria-expanded="{% if '/inventory/professor/' in request.path %}true{% else %}false{% endif %}">
                            <span class="sidebar-icon"><i class="bi bi-box-seam"></i></span>
                            <span>Materiais</span>
                        </a>
                        <div class="sidebar-dropdown-menu {% if '/inventory/professor/' in request.path %}show{% endif %}" 
                            id="materialsSubmenu">
                            <a href="{% url 'professor_material_list' %}" class="sidebar-dropdown-link {% if '/inventory/professor/materials/' in request.path %}active{% endif %}">
                                Todos os Materiais
                            </a>
                            <a href="{% url 'professor_laboratory_list' %}" class="sidebar-dropdown-link {% if '/inventory/professor/laboratories/' in request.path %}active{% endif %}">
                                Por Laboratório
                            </a>
                        </div>
                    </div>
                {% endif %}
                
                <div class="sidebar-divider"></div>
                
                <div class="sidebar-heading">Conta</div>
                
                <div class="sidebar-item">
                    <a href="{% url 'profile' %}" class="sidebar-link {% if request.path == '/profile/' %}active{% endif %}">
                        <span class="sidebar-icon"><i class="bi bi-person"></i></span>
                        <span>Perfil</span>
                    </a>
                </div>
                
                <div class="sidebar-item">
                    <a href="#" class="sidebar-link" onclick="document.getElementById('logout-form').submit(); return false;">
                        <i class="bi bi-box-arrow-right me-2"></i> Sair
                    </a>
                </div>
            </div>
        </nav>
        <!-- Sidebar backdrop -->
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    {% endif %}
    
    <!-- Content -->
    <div class="content-wrapper {% if user.is_authenticated and user.is_approved %}{% else %}login-mode{% endif %}">
        <div class="main-content">
            <!-- Header -->
            {% if user.is_authenticated and user.is_approved %}
                <header class="header">
                    <div class="header-content">
                        <div class="header-left">
                            <button type="button" class="header-toggle" id="sidebarToggleBtn">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                        
                        <div class="header-right">
                            <button type="button" class="header-theme-toggle" id="themeToggleBtn">
                                <i class="bi bi-sun-fill" id="themeIcon"></i>
                            </button>
                            
                            <div class="header-notifications">
                                <button type="button" class="header-notifications-icon" data-bs-toggle="dropdown">
                                    <i class="bi bi-bell"></i>
                                </button>
                                {% if notifications_count > 0 %}
                                    <span class="header-notifications-badge">{{ notifications_count }}</span>
                                {% endif %}
                                
                                <div class="dropdown-menu dropdown-menu-end p-0" style="width: 300px; max-height: 400px; overflow-y: auto;">
                                    <div class="p-2 border-bottom d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Notificações</h6>
                                        {% if notifications_count > 0 %}
                                        <button class="btn btn-link text-primary small p-0" onclick="markAllNotificationsRead()">
                                            Marcar todas como lidas
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="list-group list-group-flush">
                                        {% if notifications %}
                                            {% for notification in notifications %}
                                                <a href="{{ notification.url }}" class="list-group-item list-group-item-action px-3 py-2">
                                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                                        <div class="d-flex align-items-start">
                                                            <i class="{{ notification.icon }} me-2 mt-1 text-primary"></i>
                                                            <div>
                                                                <h6 class="mb-1">{{ notification.title }}</h6>
                                                                <p class="mb-1 small text-muted">{{ notification.message }}</p>
                                                            </div>
                                                        </div>
                                                        {% if notification.timestamp %}
                                                            <small class="text-muted">{{ notification.timestamp|timesince }} atrás</small>
                                                        {% endif %}
                                                    </div>
                                                </a>
                                            {% endfor %}
                                        {% else %}
                                            <div class= "text-center py-3">
                                                <p>Nenhuma notificação</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="p-2 border-top text-center">
                                        <a href="{% url 'all_notifications' %}" class="text-decoration-none text-primary">Ver todas</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="dropdown">
                                <a href="#" class="header-user" data-bs-toggle="dropdown">
                                    <div class="header-user-avatar">
                                        {{ user.first_name|first }}{{ user.last_name|first }}
                                    </div>
                                    <div class="header-user-info">
                                        <div class="header-user-name">{{ user.get_full_name }}</div>
                                        <div class="header-user-role">{{ user.get_user_type_display }}</div>
                                    </div>
                                </a>
                                
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a href="{% url 'profile' %}" class="dropdown-item">
                                        <i class="bi bi-person me-2"></i> Meu Perfil
                                    </a>
                                    <a href="#" class="dropdown-item">
                                        <i class="bi bi-gear me-2"></i> Configurações
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a href="#" class="dropdown-item" onclick="document.getElementById('logout-form').submit(); return false;">
                                        <i class="bi bi-box-arrow-right me-2"></i> Sair
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
            {% endif %}
            
                        <!-- Formulário de logout oculto -->
            <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
                {% csrf_token %}
            </form>

            <!-- Main Container -->
            <div class="main-container">
                <!-- Alerts/Messages -->
                {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                <!-- Page Content -->
                {% block content %}{% endblock %}

                {% if user.is_authenticated %}
                    {% if settings.CHATBOT_ENABLED %}
                        {% include 'components/chatbot_global.html' %}
                    {% endif %}
                {% endif %}
 
            </div>
               
            <!-- Footer -->
            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-0">&copy; {% now "Y" %} LabConnect - Unopar-Anhanguera</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p class="mb-0">Desenvolvido por Jason Inoue e Cristhian Gusso</p>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
</body>
        
    {% block extra_js %}{% endblock %}

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Core Optimized JS -->
    <script src="{% static 'js/core-optimized.js' %}"></script>
    
    <!-- Feature-specific JS (load only when needed) -->
    <script src="{% static 'js/chatbot-global.js' %}"></script>
    
    <!-- Real-time updates para performance otimizada -->
    {% if user.is_authenticated and user.is_approved %}
    <script src="{% static 'js/real-time-updates.js' %}"></script>
    {% endif %}
    
    <!-- Notification system JavaScript -->
    <script>
    function markAllNotificationsRead() {
        fetch('/scheduling/api/mark-notifications-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide notification badge
                const badge = document.querySelector('.header-notifications-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
                
                // Mark all notifications as read visually
                const notificationItems = document.querySelectorAll('.list-group-item');
                notificationItems.forEach(item => {
                    item.style.opacity = '0.6';
                });
                
                // Hide the "Mark all as read" button
                const markAllBtn = document.querySelector('button[onclick="markAllNotificationsRead()"]');
                if (markAllBtn) {
                    markAllBtn.style.display = 'none';
                }
                
                // Reload page after a short delay to reflect changes
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error marking notifications as read:', error);
        });
    }
    </script>

